<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Main Page - Nexaverse</title>
  <!-- Firebase v9.6.1 scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <style>
    /* Global & Dark Mode Styling */
    * { margin:0; padding:0; box-sizing: border-box; font-family: Arial, sans-serif; }
    body { background-color: #121212; color: #fff; }
    /* Navigation Bar */
    nav { background: #1e1e1e; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
    nav .logo { font-size: 20px; font-weight: bold; color: #ffd700; }
    nav .menu { display: flex; gap: 20px; }
    nav .menu a { color: #fff; text-decoration: none; padding: 10px; transition: color 0.3s; }
    nav .menu a:hover { color: #ffd700; }
    .profile-section { display: flex; align-items: center; gap: 10px; cursor: pointer; position: relative; }
    .profile-section img { border-radius: 50%; }
    .profile-dropdown { display: none; position: absolute; top: 50px; right: 0; background: #222; padding: 10px; border-radius: 5px; }
    .profile-section:hover .profile-dropdown { display: block; }
    /* Offline Warning */
    .offline-message { display: none; background: red; padding: 10px; text-align: center; }
    /* Main Layout */
    .container { padding: 20px; }
    .posts-section { margin-bottom: 40px; }
    .forum-section { margin-top: 40px; }
    .forum-section h2 { margin-bottom: 20px; }
    .forum-list { display: flex; flex-wrap: wrap; gap: 20px; }
    .forum-item { background: #1e1e1e; padding: 10px; border-radius: 5px; width: 200px; text-align: center; }
    .forum-item img { width: 100%; border-radius: 5px; }
    /* Admin Forum Creation Form */
    #admin-forum-form { display: none; margin-bottom: 20px; }
    #admin-forum-form input, #admin-forum-form button {
      width: 100%; padding: 10px; margin: 5px 0; border-radius: 5px; border: none;
    }
    #admin-forum-form input { background: #222; color: #fff; }
    #admin-forum-form button { background: #ffd700; color: #000; cursor: pointer; }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav>
    <div class="logo">Nexaverse</div>
    <div class="menu">
      <a href="#">Contact</a>
      <a href="#">Account</a>
      <a href="#">Forum</a>
    </div>
    <div class="profile-section">
      <img src="default-avatar.png" id="nav-avatar" width="40" height="40" alt="Avatar">
      <span id="nav-username">Loading...</span>
      <div class="profile-dropdown">
        <p id="dropdown-username"></p>
        <p id="dropdown-uid"></p>
      </div>
    </div>
  </nav>
  
  <div class="offline-message">‚ö†Ô∏è You are offline! Check your internet connection.</div>
  
  <div class="container">
    <!-- Posts Section -->
    <div class="posts-section">
      <h2>Latest Posts</h2>
      <div id="posts-container">
        <!-- Posts loaded from Firestore -->
      </div>
    </div>
    
    <!-- Forum Section -->
    <div class="forum-section">
      <h2>Forums</h2>
      <!-- Admin Forum Creation Form -->
      <div id="admin-forum-form">
        <input type="text" id="forum-title" placeholder="Forum Title" required>
        <input type="text" id="forum-name" placeholder="Forum URL Name (unique)" required>
        <input type="text" id="forum-thumbnail" placeholder="Thumbnail URL" required>
        <button id="create-forum-btn">Create Forum</button>
      </div>
      <!-- List of Forums -->
      <div class="forum-list" id="forum-list">
        <!-- Forum categories loaded from Firestore -->
      </div>
    </div>
  </div>
  
  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBMUi291fwb-HSxlGPQMxdEJGUTiOOvFBs",
      authDomain: "nexaverse-eeb07.firebaseapp.com",
      projectId: "nexaverse-eeb07",
      storageBucket: "nexaverse-eeb07.appspot.com",
      messagingSenderId: "686342300627",
      appId: "1:686342300627:web:90522d8f1129fb00b08526",
    };
    
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    // Offline Warning
    window.addEventListener("offline", () => {
      document.querySelector(".offline-message").style.display = "block";
    });
    window.addEventListener("online", () => {
      document.querySelector(".offline-message").style.display = "none";
    });
    
    // Fetch Latest Posts
    db.collection("posts").orderBy("timestamp", "desc").onSnapshot(snapshot => {
      const postsContainer = document.getElementById("posts-container");
      postsContainer.innerHTML = "";
      if (snapshot.empty) {
        postsContainer.innerHTML = "<p>No posts available.</p>";
      }
      snapshot.forEach(doc => {
        const post = doc.data();
        postsContainer.innerHTML += `
          <div class="post">
            <div class="info">
              <img src="${post.authorAvatar}" width="40" alt="Author Avatar">
              <strong>${post.authorName}</strong> (${post.role}) - ${new Date(post.timestamp.toDate()).toLocaleString()}
            </div>
            <p>${post.content}</p>
            ${ post.imageLink ? `<img src="${post.imageLink}" width="200" alt="Post Image">` : "" }
            <div class="likes">
              üëç ${post.likes || 0} | üëé ${post.dislikes || 0}
            </div>
          </div>
        `;
      });
    });
    
    // Update Nav Profile Info for logged in users
    auth.onAuthStateChanged(user => {
      if (user) {
        db.collection("users").doc(user.uid).get().then(doc => {
          const data = doc.data();
          if (data) {
            document.getElementById("nav-avatar").src = data.profilePicture || "default-avatar.png";
            document.getElementById("nav-username").textContent = data.username;
            document.getElementById("dropdown-username").textContent = data.username;
            document.getElementById("dropdown-uid").textContent = "UID: " + user.uid;
          }
        }).catch(err => console.error("Error fetching user data:", err));
      }
    });
    
    // --- Forum Section ---
    // Fetch forums from Firestore "forums" collection
    db.collection("forums").orderBy("createdAt", "desc").onSnapshot(snapshot => {
      const forumList = document.getElementById("forum-list");
      forumList.innerHTML = "";
      if (snapshot.empty) {
        forumList.innerHTML = "<p>No forums available.</p>";
      }
      snapshot.forEach(doc => {
        const forum = doc.data();
        forumList.innerHTML += `
          <div class="forum-item">
            <a href="/forum/${forum.forumName}">
              <img src="${forum.thumbnail}" alt="Forum Thumbnail">
              <h4>${forum.title}</h4>
            </a>
          </div>
        `;
      });
    });
    
    // Show Admin Forum Creation Form if user is admin
    auth.onAuthStateChanged(user => {
      if (user) {
        user.getIdTokenResult().then(idTokenResult => {
          if (idTokenResult.claims.admin) {
            document.getElementById("admin-forum-form").style.display = "block";
          } else {
            document.getElementById("admin-forum-form").style.display = "none";
          }
        }).catch(err => console.error("Error checking admin claim:", err));
      }
    });
    
    // Create Forum (Admin Only)
    document.getElementById("create-forum-btn").addEventListener("click", async () => {
      const title = document.getElementById("forum-title").value.trim();
      const forumName = document.getElementById("forum-name").value.trim();
      const thumbnail = document.getElementById("forum-thumbnail").value.trim();
      
      if (!title || !forumName || !thumbnail) return;
      
      try {
        await db.collection("forums").doc(forumName).set({
          title,
          forumName, // unique identifier for URL
          thumbnail,
          closed: false,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        // Clear form fields
        document.getElementById("forum-title").value = "";
        document.getElementById("forum-name").value = "";
        document.getElementById("forum-thumbnail").value = "";
      } catch (error) {
        console.error("Error creating forum:", error);
      }
    });
  </script>
</body>
</html>
