<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Main Page - Nexaverse</title>
  <!-- Firebase v9.6.1 scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <style>
    /* Global & Dark Mode Styling */
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
    body { background-color: #121212; color: #fff; }
    
    /* Navigation Bar */
    nav { background: #1e1e1e; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
    nav .logo { font-size: 20px; font-weight: bold; color: #ffd700; }
    nav .menu { display: flex; gap: 20px; }
    nav .menu a { color: #fff; text-decoration: none; padding: 10px; transition: color 0.3s; }
    nav .menu a:hover { color: #ffd700; }
    .profile-section { display: flex; align-items: center; gap: 10px; cursor: pointer; position: relative; }
    .profile-section img { border-radius: 50%; }
    .profile-dropdown { display: none; position: absolute; top: 50px; right: 0; background: #222; padding: 10px; border-radius: 5px; }
    .profile-section:hover .profile-dropdown { display: block; }
    
    /* Offline Warning */
    .offline-message { display: none; background: red; padding: 10px; text-align: center; }
    
    /* Main Layout */
    .container { display: flex; gap: 20px; padding: 20px; }
    .main-content { flex: 2; background: #1e1e1e; padding: 20px; border-radius: 10px; }
    .sidebar { flex: 1; background: #1e1e1e; padding: 20px; border-radius: 10px; }
    
    /* Posts */
    .post { background: #333; padding: 15px; margin-bottom: 15px; border-radius: 10px; }
    .post .info { display: flex; align-items: center; gap: 10px; }
    .post .likes { margin-top: 10px; display: flex; gap: 10px; }
    
    /* Admin Post Form */
    #admin-post-form { display: none; margin-bottom: 20px; }
    #admin-post-form textarea, #admin-post-form input, #admin-post-form button {
      width: 100%; padding: 10px; margin: 5px 0; border-radius: 5px; border: none;
    }
    #admin-post-form textarea, #admin-post-form input { background: #222; color: #fff; }
    #admin-post-form button { background: #ffd700; color: #000; cursor: pointer; }
    
    /* Sidebar List Styling */
    .sidebar ul { list-style: none; padding: 0; }
    .sidebar li { margin-bottom: 10px; }
    
    /* Responsive */
    @media (max-width: 768px) {
      .container { flex-direction: column; }
    }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav>
    <div class="logo">Nexaverse</div>
    <div class="menu">
      <a href="#">Contact</a>
      <a href="#">Account</a>
      <a href="#">Forum</a>
    </div>
    <div class="profile-section">
      <img src="default-avatar.png" id="nav-avatar" width="40" height="40" alt="User Avatar">
      <span id="nav-username">Loading...</span>
      <div class="profile-dropdown">
        <p id="dropdown-username"></p>
        <p id="dropdown-uid"></p>
      </div>
    </div>
  </nav>
  
  <div class="offline-message">‚ö†Ô∏è You are offline! Check your internet connection.</div>
  
  <!-- Page Content -->
  <div class="container">
    <div class="main-content">
      <h2>Latest Posts</h2>
      <!-- Admin Post Form (visible only for admins) -->
      <div id="admin-post-form">
        <textarea id="post-text" placeholder="Enter post text..."></textarea>
        <input type="text" id="post-image" placeholder="Image link (optional)" />
        <button id="post-btn">Post</button>
      </div>
      <div id="posts-container"></div>
    </div>
    <div class="sidebar">
      <h3>Last Registered User</h3>
      <ul id="last-registered"></ul>
      <h3>Weekly Visits</h3>
      <p id="weekly-visits">Loading...</p>
    </div>
  </div>
  
  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBMUi291fwb-HSxlGPQMxdEJGUTiOOvFBs",
      authDomain: "nexaverse-eeb07.firebaseapp.com",
      projectId: "nexaverse-eeb07",
      storageBucket: "nexaverse-eeb07.appspot.com",
      messagingSenderId: "686342300627",
      appId: "1:686342300627:web:90522d8f1129fb00b08526",
    };
  
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
  
    // --- Weekly Visits ---
    async function updateVisits() {
      const visitsRef = db.collection("stats").doc("weeklyVisits");
      const docSnapshot = await visitsRef.get();
      if (docSnapshot.exists) {
        visitsRef.update({ count: firebase.firestore.FieldValue.increment(1) });
      } else {
        visitsRef.set({ count: 1 });
      }
    }
    updateVisits();
  
    db.collection("stats").doc("weeklyVisits").onSnapshot((doc) => {
      if (doc.exists) {
        document.getElementById("weekly-visits").innerText = `This week: ${doc.data().count}`;
      }
    });
  
    // --- Last Registered User ---
    db.collection("users").orderBy("createdAt", "desc").limit(1).onSnapshot((snapshot) => {
      const lastRegistered = document.getElementById("last-registered");
      lastRegistered.innerHTML = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        lastRegistered.innerHTML += `<li>${data.username}<br><img src="${data.profilePicture}" width="50" alt="User Pic"></li>`;
      });
    });
  
    // --- Latest Posts ---
    db.collection("posts").orderBy("timestamp", "desc").onSnapshot((snapshot) => {
      const postsContainer = document.getElementById("posts-container");
      postsContainer.innerHTML = "";
      snapshot.forEach(doc => {
        const post = doc.data();
        postsContainer.innerHTML += `
          <div class="post">
            <div class="info">
              <img src="${post.authorAvatar}" width="40" alt="Author Avatar">
              <strong>${post.authorName}</strong> (${post.role}) - ${new Date(post.timestamp.toDate()).toLocaleString()}
            </div>
            <p>${post.content}</p>
            ${ post.imageLink ? `<img src="${post.imageLink}" width="200" alt="Post Image">` : "" }
            <div class="likes">
              üëç ${post.likes || 0} | üëé ${post.dislikes || 0}
            </div>
          </div>
        `;
      });
    });
  
    // --- Admin Post Form ---
    // Check if the logged-in user is an admin
    auth.onAuthStateChanged(user => {
      if (user) {
        // Retrieve custom claims from the ID token
        user.getIdTokenResult().then(idTokenResult => {
          if (idTokenResult.claims.admin) {
            document.getElementById("admin-post-form").style.display = "block";
          } else {
            document.getElementById("admin-post-form").style.display = "none";
          }
        });
        // Update nav profile info
        db.collection("users").doc(user.uid).get().then(doc => {
          const data = doc.data();
          if (data) {
            document.getElementById("nav-avatar").src = data.profilePicture || "default-avatar.png";
            document.getElementById("nav-username").textContent = data.username;
            document.getElementById("dropdown-username").textContent = data.username;
            document.getElementById("dropdown-uid").textContent = "UID: " + user.uid;
          }
        });
      }
    });
  
    // --- Post Submission (Admin only) ---
    document.getElementById("post-btn").addEventListener("click", async () => {
      const content = document.getElementById("post-text").value.trim();
      const imageLink = document.getElementById("post-image").value.trim();
      if (!content) return;
  
      const user = auth.currentUser;
      if (!user) return;
  
      const postData = {
        content,
        imageLink: imageLink || null,
        authorName: user.displayName || "Admin",
        authorAvatar: user.photoURL || "default-avatar.png",
        role: "admin",
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        likes: 0,
        dislikes: 0
      };
  
      await db.collection("posts").add(postData);
      document.getElementById("post-text").value = "";
      document.getElementById("post-image").value = "";
    });
  
    // --- Offline Warning ---
    window.addEventListener("offline", () => {
      document.querySelector(".offline-message").style.display = "block";
    });
    window.addEventListener("online", () => {
      document.querySelector(".offline-message").style.display = "none";
    });
  </script>
</body>
</html>
