<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Chat</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #121212;
            color: white;
            display: flex;
            height: 100vh;
            margin: 0;
        }
        .sidebar {
            width: 250px;
            background: #1e1e1e;
            padding: 20px;
            overflow-y: auto;
        }
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .chat-box {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        .chat-input {
            display: flex;
            padding: 10px;
            background: #1e1e1e;
        }
        textarea {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            resize: none;
        }
        button {
            margin-left: 10px;
            padding: 10px 20px;
            border: none;
            background: #007bff;
            color: white;
            border-radius: 20px;
            cursor: pointer;
        }
        .chat-message {
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        .chat-message img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .message-header {
            display: flex;
            align-items: center;
        }
        .message-header strong {
            margin-right: 10px;
        }
        .role.admin {
            color: red;
        }
        .role.member {
            color: #007bff;
        }
    </style>
</head>
<body>
    <div class="sidebar" id="membersSection">Loading members...</div>
    <div class="chat-container">
        <div class="chat-box" id="chatSection">Loading messages...</div>
        <div class="chat-input">
            <textarea id="chatInput" rows="2" placeholder="Type a message..."></textarea>
            <button id="sendChatButton">Send</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, getDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBMUi291fwb-HSxlGPQMxdEJGUTiOOvFBs",
            authDomain: "nexaverse-eeb07.firebaseapp.com",
            projectId: "nexaverse-eeb07",
            storageBucket: "nexaverse-eeb07.appspot.com",
            messagingSenderId: "686342300627",
            appId: "1:686342300627:web:90522d8f1129fb00b08526",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        function loadMembers() {
            const membersSection = document.getElementById("membersSection");
            const usersQuery = query(collection(db, "users"));
            onSnapshot(usersQuery, (snapshot) => {
                membersSection.innerHTML = "";
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const memberEl = document.createElement("div");
                    memberEl.className = "member-card";
                    memberEl.innerHTML = `
                        <img src="${data.pfp || 'default-avatar.png'}" alt="Avatar">
                        <strong class="role ${data.role}">${data.name}</strong>
                    `;
                    membersSection.appendChild(memberEl);
                });
            });
        }
        loadMembers();

        function loadChat() {
            const chatSection = document.getElementById("chatSection");
            const chatQuery = query(collection(db, "globalChat"), orderBy("timestamp", "asc"));
            onSnapshot(chatQuery, (snapshot) => {
                chatSection.innerHTML = "";
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const messageEl = document.createElement("div");
                    messageEl.className = "chat-message";
                    messageEl.innerHTML = `
                        <div class="message-header">
                            <img src="${data.profilePic || 'default-avatar.png'}" alt="Avatar">
                            <strong class="role ${data.role}">${data.username}</strong>
                            <small>${data.timestamp ? new Date(data.timestamp.toDate()).toLocaleTimeString() : ""}</small>
                        </div>
                        <div class="message-content">${data.text.replace(/\n/g, '<br>')}</div>
                    `;
                    chatSection.appendChild(messageEl);
                });
                chatSection.scrollTop = chatSection.scrollHeight;
            });
        }
        loadChat();

        document.getElementById("sendChatButton").addEventListener("click", async () => {
            const textArea = document.getElementById("chatInput");
            const text = textArea.value.trim();
            if (!text) return;
            const user = auth.currentUser;
            if (!user) return alert("You must be logged in!");
            const userDocSnap = await getDoc(doc(db, "users", user.uid));
            if (!userDocSnap.exists()) return alert("User not found!");
            await addDoc(collection(db, "globalChat"), {
                text,
                profilePic: userDocSnap.data().pfp,
                username: userDocSnap.data().name,
                role: userDocSnap.data().role,
                timestamp: serverTimestamp()
            });
            textArea.value = "";
        });

        document.getElementById("chatInput").addEventListener("keydown", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                document.getElementById("sendChatButton").click();
            }
        });
    </script>
</body>
</html>
